<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SyncKit Cursors - Simple Viewport Test</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .status {
      font-family: monospace;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }

    .status-ok { color: #22c55e; }
    .status-waiting { color: #f59e0b; }

    .workspace {
      background: white;
      min-height: 500px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 40px;
    }

    .instructions {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .instructions h3 {
      color: #1e40af;
      margin-bottom: 10px;
    }

    .instructions ol {
      margin-left: 20px;
    }

    .instructions li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // Simulate awareness state from remote users
    function useSimulatedRemoteUsers() {
      const [users, setUsers] = useState([]);

      useEffect(() => {
        // Listen for messages from other tabs
        const handleMessage = (event) => {
          if (event.data.type === 'CURSOR_UPDATE') {
            const { userId, cursor, name, color } = event.data;

            setUsers(prevUsers => {
              const existingIndex = prevUsers.findIndex(u => u.id === userId);
              const user = {
                id: userId,
                name,
                color,
                cursor
              };

              if (existingIndex >= 0) {
                const newUsers = [...prevUsers];
                newUsers[existingIndex] = user;
                return newUsers;
              } else {
                return [...prevUsers, user];
              }
            });
          }
        };

        // Use BroadcastChannel for cross-tab communication
        const bc = new BroadcastChannel('synckit_cursors');
        bc.onmessage = handleMessage;

        return () => {
          bc.close();
        };
      }, []);

      return users;
    }

    // Simple cursor component using viewport-relative positioning
    function Cursor({ user }) {
      if (!user.cursor) return null;

      return (
        <div
          data-cursor-id={user.id}
          style={{
            position: 'fixed',
            left: 0,
            top: 0,
            transform: `translate(${user.cursor.x}px, ${user.cursor.y}px)`,
            pointerEvents: 'none',
            zIndex: 9999,
            transition: 'transform 0.1s ease-out'
          }}
        >
          {/* Cursor pointer */}
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            style={{ filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.2))' }}
          >
            <path
              d="M5 3L19 12L12 13L9 19L5 3Z"
              fill={user.color}
              stroke="white"
              strokeWidth="1.5"
            />
          </svg>

          {/* Label */}
          <div
            style={{
              position: 'absolute',
              left: '20px',
              top: '0px',
              backgroundColor: user.color,
              color: 'white',
              padding: '2px 8px',
              borderRadius: '4px',
              fontSize: '12px',
              fontWeight: 500,
              whiteSpace: 'nowrap',
              boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
            }}
          >
            {user.name}
          </div>
        </div>
      );
    }

    function App() {
      const [localCursor, setLocalCursor] = useState(null);
      const [userId] = useState(() => 'user_' + Math.random().toString(36).substr(2, 9));
      const [userName] = useState(() => 'Tab ' + (Math.floor(Math.random() * 10) + 1));
      const [userColor] = useState(() => {
        const hue = Math.floor(Math.random() * 360);
        return `hsl(${hue}, 70%, 50%)`;
      });

      const remoteUsers = useSimulatedRemoteUsers();

      // Broadcast cursor position to other tabs
      const broadcastCursor = useCallback((cursor) => {
        const bc = new BroadcastChannel('synckit_cursors');
        bc.postMessage({
          type: 'CURSOR_UPDATE',
          userId,
          cursor,
          name: userName,
          color: userColor
        });
        bc.close();
      }, [userId, userName, userColor]);

      // Track mouse movement - simple viewport coordinates!
      const handleMouseMove = useCallback((e) => {
        const cursor = {
          x: Math.round(e.clientX),
          y: Math.round(e.clientY)
        };

        setLocalCursor(cursor);
        broadcastCursor(cursor);
      }, [broadcastCursor]);

      return (
        <div onMouseMove={handleMouseMove}>
          <div className="header">
            <h1>üéØ SyncKit Cursors - Simple Viewport Test</h1>
            <p>Testing simple viewport-relative cursor positioning (Liveblocks pattern)</p>

            <div className="status">
              <div className="status-ok">‚úì Using position: fixed with clientX/clientY</div>
              <div className="status-ok">‚úì No container ref needed</div>
              <div className="status-ok">‚úì No scroll handling needed</div>
              <div className="status-ok">‚úì No coordinate transformations</div>
              <div style={{ marginTop: '10px' }}>
                Your cursor: x={localCursor?.x || 0}, y={localCursor?.y || 0}
              </div>
              <div>
                Remote cursors: {remoteUsers.length}
              </div>
            </div>
          </div>

          <div className="instructions">
            <h3>How to test:</h3>
            <ol>
              <li>Open this file in <strong>two browser tabs</strong> side by side</li>
              <li>Move your mouse in Tab A</li>
              <li>Watch Tab B - you should see your cursor appear and follow your movements</li>
              <li>Move your mouse in Tab B</li>
              <li>Watch Tab A - you should see Tab B's cursor</li>
            </ol>
            <p style={{ marginTop: '10px', color: '#dc2626', fontWeight: 500 }}>
              ‚ö†Ô∏è If cursors don't appear or positions are wrong, we have a bug!
            </p>
          </div>

          <div className="workspace">
            <h2>Workspace Area</h2>
            <p>Move your mouse around this area to test cursor tracking.</p>
            <p style={{ marginTop: '10px', color: '#6b7280' }}>
              Cursors should appear exactly where you move your mouse, with no offset bugs.
            </p>
          </div>

          {/* Render remote cursors */}
          {remoteUsers.map(user => (
            <Cursor key={user.id} user={user} />
          ))}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
