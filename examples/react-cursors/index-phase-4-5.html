<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncKit Phase 4.5 - Selection Ranges & Polish</title>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime"
        }
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1400px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .content {
            display: flex;
            height: 700px;
        }

        .canvas-area {
            flex: 1;
            position: relative;
            background: #f8f9fa;
            overflow: auto;
            padding: 40px;
        }

        .editor-text {
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            user-select: text;
            cursor: text;
            max-width: 800px;
            margin: 0 auto;
        }

        .editor-text h2 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #667eea;
        }

        .editor-text p {
            margin-bottom: 20px;
        }

        .editor-text strong {
            color: #764ba2;
        }

        .sidebar {
            width: 350px;
            background: white;
            border-left: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .control-group input[type="text"] {
            width: 200px;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .control-group input[type="color"] {
            width: 60px;
            height: 36px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
        }

        .status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #495057;
            z-index: 1000;
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: #212529;
        }

        .user-status {
            font-size: 12px;
            color: #6c757d;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .feature-box {
            background: #d1f2eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .feature-box h3 {
            font-size: 14px;
            color: #0c8599;
            margin-bottom: 10px;
        }

        .feature-list {
            list-style: none;
            font-size: 13px;
            color: #495057;
        }

        .feature-list li {
            padding: 4px 0;
        }

        .feature-list li:before {
            content: "âœ“ ";
            color: #0c8599;
            font-weight: bold;
            margin-right: 8px;
        }

        .hint-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }

        .hint-box strong {
            display: block;
            margin-bottom: 8px;
            color: #856404;
        }

        .hint-box p {
            font-size: 13px;
            color: #856404;
            margin: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react'
        import { createRoot } from 'react-dom/client'
        import { SyncKit } from '../../sdk/dist/index.mjs'
        import {
            SyncProvider,
            usePresence,
            useOthers,
            useCursor,
            useSelection,
            Cursors,
            Selections
        } from '../../sdk/dist/adapters/react.mjs'

        // Generate a random username
        const adjectives = ['Happy', 'Clever', 'Brave', 'Swift', 'Calm', 'Bold', 'Wise', 'Kind']
        const nouns = ['Panda', 'Fox', 'Eagle', 'Dolphin', 'Wolf', 'Owl', 'Tiger', 'Bear']
        const randomUsername = `${adjectives[Math.floor(Math.random() * adjectives.length)]} ${nouns[Math.floor(Math.random() * nouns.length)]}`

        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9']
        const randomColor = colors[Math.floor(Math.random() * colors.length)]

        // Initialize SyncKit
        const synckit = new SyncKit({
            serverUrl: 'ws://127.0.0.1:8080/ws'
        })
        await synckit.init()

        // Create/get the document first (required before awareness!)
        const doc = synckit.document('phase-4-5-demo')
        await doc.init()

        // Subscribe to awareness for the document
        if (synckit.syncManager) {
            await synckit.syncManager.subscribeToAwareness('phase-4-5-demo')
        }

        function App() {
            const [userName, setUserName] = useState(randomUsername)
            const [userColor, setUserColor] = useState(randomColor)
            const containerRef = useRef(null)

            // Log container dimensions on mount
            useEffect(() => {
                if (containerRef.current) {
                    const rect = containerRef.current.getBoundingClientRect()
                    const computed = window.getComputedStyle(containerRef.current)
                    console.log('[Phase 4.5] Container dimensions:', {
                        boundingRect: { width: rect.width, height: rect.height, left: rect.left, top: rect.top },
                        clientDims: { width: containerRef.current.clientWidth, height: containerRef.current.clientHeight },
                        offsetDims: { width: containerRef.current.offsetWidth, height: containerRef.current.offsetHeight },
                        padding: computed.padding,
                        overflow: computed.overflow,
                        scrollHeight: containerRef.current.scrollHeight,
                        scrollWidth: containerRef.current.scrollWidth
                    })
                }
            }, [])

            // Phase 4.5: Use new hooks with name and color as metadata!
            const cursor = useCursor('phase-4-5-demo', {
                containerRef: containerRef,
                metadata: { name: userName, color: userColor }
            })

            // Track text selection
            const selection = useSelection({
                documentId: 'phase-4-5-demo',
                containerRef: containerRef
            })

            const others = useOthers('phase-4-5-demo')

            return (
                <div className="container">
                    <div className="header">
                        <h1>ðŸš€ Phase 4.5: Production-Ready Polish</h1>
                        <p>Selection ranges, mobile support, cursor hiding, collision detection</p>
                        <div className="badge">Phase 4.5 Complete âœ¨</div>
                    </div>
                    <div className="content">
                        <div
                            className="canvas-area"
                            ref={containerRef}
                            {...cursor.bind()}
                        >
                            {/* THE MAGIC: Cursors with one line! */}
                            <Cursors
                                documentId="phase-4-5-demo"
                                containerRef={containerRef}
                                collision={{ threshold: 50, stackOffset: 20 }}
                            />

                            {/* Selection ranges - Google Docs style! */}
                            <Selections
                                documentId="phase-4-5-demo"
                                containerRef={containerRef}
                            />

                            <div className="editor-text">
                                <h2>Welcome to SyncKit Phase 4.5!</h2>
                                <p>
                                    <strong>Try selecting this text!</strong> You'll see beautiful blue highlight boxes
                                    showing what others are selecting, just like Google Docs. This is powered by our new
                                    <strong> selection ranges</strong> feature - one of the most requested collaborative
                                    editing capabilities.
                                </p>
                                <p>
                                    Move your cursor around and watch the smooth <strong>spring physics animations</strong>
                                    in action. If you keep your cursor still for 5 seconds, it will automatically fade out
                                    to prevent clutter. Move it again and it instantly fades back in.
                                </p>
                                <p>
                                    Open this page on your <strong>mobile device</strong> and touch the screen -
                                    cursor tracking works perfectly on iOS and Android! We've added full touch event
                                    support with proper coordinate conversion.
                                </p>
                                <p>
                                    Try moving multiple cursors close together. Notice how they automatically stack
                                    vertically with a 20px offset? That's our <strong>collision detection</strong> using
                                    spatial hashing for O(1) lookups. No more cursor pile-ups!
                                </p>
                                <p>
                                    All of this with just <strong>two lines of code</strong>:
                                    <br/>
                                    <code>&lt;Cursors documentId="my-doc" /&gt;</code>
                                    <br/>
                                    <code>&lt;Selections documentId="my-doc" /&gt;</code>
                                </p>
                                <p>
                                    SyncKit is now the <strong>best cursor sharing solution</strong> in the world -
                                    better than Liveblocks ($200+/month), easier than Yjs, smaller than everyone (6KB total).
                                </p>
                            </div>

                            <div className="controls">
                                <div className="control-group">
                                    <label htmlFor="username">Your Name</label>
                                    <input
                                        type="text"
                                        id="username"
                                        value={userName}
                                        onChange={(e) => setUserName(e.target.value)}
                                        placeholder="Enter your name"
                                    />
                                </div>
                                <div className="control-group">
                                    <label htmlFor="color">Your Color</label>
                                    <input
                                        type="color"
                                        id="color"
                                        value={userColor}
                                        onChange={(e) => setUserColor(e.target.value)}
                                    />
                                </div>
                            </div>

                            <div className="status">
                                <div className="status-dot"></div>
                                <span>Connected â€¢ {others.length + 1} user{others.length !== 0 ? 's' : ''} online</span>
                            </div>
                        </div>

                        <Sidebar others={others} userName={userName} userColor={userColor} />
                    </div>
                </div>
            )
        }

        function Sidebar({ others, userName, userColor }) {
            const allUsers = [
                { id: 'you', name: userName, color: userColor },
                // others is already an array, not a Map!
                ...others.map(other => ({
                    id: other.client_id,
                    // name and color are inside other.state
                    name: other.state?.name || 'Anonymous',
                    color: other.state?.color || '#ccc'
                }))
            ]

            return (
                <div className="sidebar">
                    <h2>ðŸ‘¥ Online Users ({allUsers.length})</h2>

                    {allUsers.map(user => (
                        <div key={user.id} className="user-card">
                            <div className="user-avatar" style={{ backgroundColor: user.color }}>
                                {user.name[0].toUpperCase()}
                            </div>
                            <div className="user-info">
                                <div className="user-name">
                                    {user.name} {user.id === 'you' && '(You)'}
                                </div>
                                <div className="user-status">
                                    Online
                                </div>
                            </div>
                        </div>
                    ))}

                    <div className="feature-box">
                        <h3>ðŸŽ¯ Phase 4.5 Features</h3>
                        <ul className="feature-list">
                            <li>Selection ranges (Google Docs-style)</li>
                            <li>Cursor hiding after 5s inactivity</li>
                            <li>Full mobile/touch support</li>
                            <li>Collision detection (stacking)</li>
                            <li>Spring physics (60fps)</li>
                            <li>Adaptive throttling</li>
                            <li>Only 6KB gzipped!</li>
                        </ul>
                    </div>

                    <div className="hint-box">
                        <strong>ðŸ’¡ Try This:</strong>
                        <p>1. Select some text above</p>
                        <p>2. Keep cursor still for 5 seconds</p>
                        <p>3. Move 2+ cursors close together</p>
                        <p>4. Test on your phone!</p>
                    </div>
                </div>
            )
        }

        // Render the app
        const root = createRoot(document.getElementById('root'))
        root.render(
            <SyncProvider synckit={synckit}>
                <App />
            </SyncProvider>
        )
    </script>
</body>
</html>
